$baseOUs = "tel aviv", "holon", "hifa"  # Base OUs to be created
$childOUs = "users", "computers", "groups"  # Child OUs to be created within each base OU
$domain = "DC=kernel,DC=com"  # Replace with your actual domain DN (Distinguished Name)
$defaultPassword = ConvertTo-SecureString "qwer4321!" -AsPlainText -Force  # Replace with your desired default password

foreach ($baseOU in $baseOUs) {
    $baseOUPath = "OU=$baseOU,$domain"

    # Create base OU and child OUs
    New-ADOrganizationalUnit -Name $baseOU -Path $domain
    $childOUs | ForEach-Object { New-ADOrganizationalUnit -Name $_ -Path "$baseOUPath" }

    # Create users
    $usersOUPath = "OU=users,$baseOUPath"
    1..10 | ForEach-Object {
        $username = "user${baseOU}_$_"
        New-ADUser -Name $username -GivenName "User" -Surname "$baseOU $_" -SamAccountName $username `
                    -UserPrincipalName "$username@kernel.com" -Path $usersOUPath `
                    -AccountPassword $defaultPassword -Enabled $true  # Adjust the password if necessary
    }

    # Create group and add users
    $groupName = "Group_$baseOU"
    $groupsOUPath = "OU=groups,$baseOUPath"
    New-ADGroup -Name $groupName -GroupScope Global -Path $groupsOUPath -Description "Group for $baseOU"

    Get-ADUser -Filter * -SearchBase $usersOUPath | ForEach-Object {
        Add-ADGroupMember -Identity $groupName -Members $_.SamAccountName
    }
}

Write-Host "OUs, users, and groups have been created successfully."
